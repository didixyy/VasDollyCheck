name: Build VasDolly Tool

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Download and setup JRE (macOS ARM64)
      run: |
        mkdir -p resources/jre/macos downloads
        # 检测架构
        if [[ $(uname -m) == 'arm64' ]]; then
          JRE_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_aarch64_mac_hotspot_11.0.21_9.tar.gz"
        else
          JRE_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_x64_mac_hotspot_11.0.21_9.tar.gz"
        fi
        curl -L -o downloads/jre.tar.gz "$JRE_URL"
        tar -xzf downloads/jre.tar.gz -C downloads/
        JRE_DIR=$(find downloads -type d -name "*jre*" -maxdepth 1 | head -1)
        if [ -d "$JRE_DIR/Contents/Home" ]; then
          cp -r "$JRE_DIR/Contents/Home/"* resources/jre/macos/
        else
          cp -r "$JRE_DIR/"* resources/jre/macos/
        fi
        chmod +x resources/jre/macos/bin/*
    
    - name: Build application
      run: |
        python build.py
    
    - name: Archive macOS app
      run: |
        cd dist
        zip -r VasDollyTool-macOS.zip VasDollyTool.app
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VasDollyTool-macOS
        path: dist/VasDollyTool-macOS.zip

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Download and setup JRE (Windows x64)
      run: |
        New-Item -ItemType Directory -Force -Path resources\jre\windows, downloads
        $JRE_URL = "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_x64_windows_hotspot_11.0.21_9.zip"
        Invoke-WebRequest -Uri $JRE_URL -OutFile "downloads\jre.zip"
        Expand-Archive -Path "downloads\jre.zip" -DestinationPath "downloads\temp" -Force
        $JRE_DIR = Get-ChildItem -Path "downloads\temp" -Directory | Select-Object -First 1
        Copy-Item -Path "$($JRE_DIR.FullName)\*" -Destination "resources\jre\windows" -Recurse -Force
    
    - name: Build application
      run: |
        python build.py
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VasDollyTool-Windows
        path: dist/VasDollyTool.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: VasDollyTool-macOS
        path: ./artifacts
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: VasDollyTool-Windows
        path: ./artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/VasDollyTool-macOS.zip
          ./artifacts/VasDollyTool.exe
        body: |
          ## VasDolly 渠道工具
          
          ### 下载
          
          **macOS版本（包含JRE）**
          - VasDollyTool-macOS.zip (~60-80MB)
          - 支持 Intel 和 Apple Silicon
          - 无需安装Java，开箱即用
          
          **Windows版本（包含JRE）**
          - VasDollyTool.exe (~60-80MB)
          - 支持 Windows 10/11 x64
          - 无需安装Java，开箱即用
          
          ### 功能特性
          - ✅ 解析APK渠道信息
          - ✅ 批量生成多渠道包
          - ✅ 内置Java运行环境
          - ✅ 图形化操作界面
          
          ### 使用说明
          查看项目README获取详细使用指南
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

