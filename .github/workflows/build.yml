name: Build VasDolly Tool

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Download and setup JRE (macOS ARM64)
      run: |
        mkdir -p resources/jre/macos downloads
        # æ£€æµ‹æ¶æ„
        if [[ $(uname -m) == 'arm64' ]]; then
          JRE_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_aarch64_mac_hotspot_11.0.21_9.tar.gz"
        else
          JRE_URL="https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_x64_mac_hotspot_11.0.21_9.tar.gz"
        fi
        curl -L -o downloads/jre.tar.gz "$JRE_URL"
        tar -xzf downloads/jre.tar.gz -C downloads/
        JRE_DIR=$(find downloads -type d -name "*jre*" -maxdepth 1 | head -1)
        if [ -d "$JRE_DIR/Contents/Home" ]; then
          cp -r "$JRE_DIR/Contents/Home/"* resources/jre/macos/
        else
          cp -r "$JRE_DIR/"* resources/jre/macos/
        fi
        chmod +x resources/jre/macos/bin/*
    
    - name: Build application
      run: |
        python build.py
    
    - name: Archive macOS app
      run: |
        cd dist
        zip -r VasDollyTool-macOS.zip VasDollyTool.app
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VasDollyTool-macOS
        path: dist/VasDollyTool-macOS.zip

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Download and setup JRE (Windows x64)
      run: |
        New-Item -ItemType Directory -Force -Path resources\jre\windows, downloads
        $JRE_URL = "https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.21%2B9/OpenJDK11U-jre_x64_windows_hotspot_11.0.21_9.zip"
        Invoke-WebRequest -Uri $JRE_URL -OutFile "downloads\jre.zip"
        Expand-Archive -Path "downloads\jre.zip" -DestinationPath "downloads\temp" -Force
        $JRE_DIR = Get-ChildItem -Path "downloads\temp" -Directory | Select-Object -First 1
        Copy-Item -Path "$($JRE_DIR.FullName)\*" -Destination "resources\jre\windows" -Recurse -Force
    
    - name: Build application
      run: |
        python build.py
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VasDollyTool-Windows
        path: dist/VasDollyTool.exe

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    
    steps:
    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: VasDollyTool-macOS
        path: ./artifacts
    
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: VasDollyTool-Windows
        path: ./artifacts
    
    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: VasDollyæ¸ é“è§£æå·¥å…· v1.0.${{ github.run_number }}
        files: |
          ./artifacts/VasDollyTool-macOS.zip
          ./artifacts/VasDollyTool.exe
        body: |
          ## ğŸ“¦ VasDolly æ¸ é“è§£æå·¥å…·
          
          ### ä¸‹è½½
          
          **ğŸ macOSç‰ˆæœ¬**
          - ä¸‹è½½ `VasDollyTool-macOS.zip` 
          - è§£å‹åè¿è¡Œï¼ˆçº¦60-80MBï¼‰
          - æ”¯æŒ Intel å’Œ Apple Silicon
          - æ— éœ€å®‰è£…Java
          
          **ğŸªŸ Windowsç‰ˆæœ¬**
          - ä¸‹è½½ `VasDollyTool.exe` ç›´æ¥è¿è¡Œ
          - æ”¯æŒ Windows 10/11 x64ï¼ˆçº¦60-80MBï¼‰
          - æ— éœ€å®‰è£…Java
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - âœ… ä¸€é”®è§£æAPKæ¸ é“ä¿¡æ¯
          - âœ… å†…ç½®Javaè¿è¡Œç¯å¢ƒï¼Œå¼€ç®±å³ç”¨
          - âœ… ç®€æ´å‹å¥½çš„å›¾å½¢ç•Œé¢
          - âœ… æ”¯æŒVasDollyå¤šæ¸ é“APK
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. è¿è¡Œç¨‹åº
          2. ç‚¹å‡»"é€‰æ‹© APK æ–‡ä»¶"æŒ‰é’®
          3. è‡ªåŠ¨è§£æå¹¶æ˜¾ç¤ºæ¸ é“ä¿¡æ¯
          
          ---
          **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          **æ„å»ºç¼–å·**: #${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

